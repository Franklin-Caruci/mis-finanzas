<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Master V8.4 - Editor</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .tab-active { border-bottom: 4px solid #4f46e5; color: #4f46e5; font-weight: 800; }
        .toast { transition: all 0.3s ease; transform: translateY(100px); opacity: 0; position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .editing-mode { border: 2px solid #4f46e5 !important; background-color: #f5f3ff !important; }
    </style>
</head>
<body class="pb-20">

    <div id="toast-container"></div>

    <header class="bg-slate-900 text-white p-5 shadow-xl sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-xl font-black italic uppercase">Finanzas <span class="text-indigo-400">V8.4 PRO</span></h1>

            <div class="flex items-center gap-4 bg-slate-800 p-2 px-4 rounded-2xl border border-slate-700">
                <div class="text-right">
                    <p class="text-[8px] font-bold text-slate-400 uppercase tracking-widest">Tasa (1$ = Bs)</p>
                    <input type="number" id="exchangeRate" value="45.00" step="0.01" class="bg-transparent text-lg font-black text-white w-20 outline-none border-b border-indigo-500">
                </div>
            </div>

            <div class="flex gap-2">
                <label class="cursor-pointer bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded-xl font-bold text-[10px] transition-all flex items-center shadow-lg">
                    IMPORTAR <input type="file" id="importFile" class="hidden" accept=".csv">
                </label>
                <button id="btnExport" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-xl font-bold text-[10px] transition-all shadow-lg">EXPORTAR</button>
                <button id="btnToggleCharts" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-xl font-bold text-[10px] transition-all shadow-lg">GRÁFICOS</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-6">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <p class="text-indigo-300 text-[10px] font-black uppercase tracking-[0.3em]">Patrimonio Neto Total (USD)</p>
                <div class="flex flex-col md:flex-row md:items-end gap-3 mt-2">
                    <h2 id="saldoNetoUSD" class="text-5xl font-black tracking-tighter">$ 0.00</h2>
                    <h3 id="saldoNetoBS" class="text-2xl font-bold text-slate-500 mb-1">Bs 0,00</h3>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] p-6 card-shadow border border-slate-100">
                <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest">Saldos & Conciliación</h3>
                <div id="bankSaldos" class="space-y-2 mb-4"></div>
                
                <div class="pt-4 border-t border-slate-100">
                    <div class="flex gap-2">
                        <select id="adjAcc" class="text-[10px] p-2 bg-slate-50 rounded-lg outline-none w-1/2">
                            <option value="banco1">Banesco</option><option value="banco2">BNC</option><option value="banco3">Bancaribe</option><option value="caja">Caja</option>
                        </select>
                        <input type="number" id="adjVal" placeholder="Saldo Real $" class="text-[10px] p-2 bg-slate-50 rounded-lg outline-none w-1/2 border border-slate-100">
                    </div>
                    <button onclick="app.quickAdjust()" class="w-full mt-2 bg-indigo-50 text-indigo-600 text-[9px] font-black py-2 rounded-lg hover:bg-indigo-100 uppercase">Ajustar Saldo</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] card-shadow overflow-hidden border border-slate-100" id="formContainer">
            <div class="flex flex-wrap bg-slate-50 border-b" id="tabGroup">
                <button data-cat="ingresos" class="flex-1 py-4 text-[9px] uppercase tracking-[0.2em] tab-active">Ingreso</button>
                <button data-cat="egresos" class="flex-1 py-4 text-[9px] uppercase tracking-[0.2em] text-slate-400">Egreso</button>
                <button data-cat="cobrar" class="flex-1 py-4 text-[9px] uppercase tracking-[0.2em] text-slate-400">Cobrar</button>
                <button data-cat="pagar" class="flex-1 py-4 text-[9px] uppercase tracking-[0.2em] text-slate-400">Pagar</button>
            </div>
            <div class="p-6">
                <div id="editBadge" class="hidden mb-4 bg-indigo-600 text-white text-[9px] font-bold px-3 py-1 rounded-full inline-block uppercase tracking-widest">Modo Edición Activado</div>
                <form id="financeForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="date" id="inputDate" required class="p-3 bg-slate-50 rounded-xl text-sm border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <input type="text" id="inputDesc" placeholder="Concepto" required class="p-3 bg-slate-50 rounded-xl text-sm border-none ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <input type="number" id="inputAmount" step="0.01" placeholder="Monto $" required class="p-3 bg-slate-50 rounded-xl text-sm font-bold text-indigo-600 border-none ring-1 ring-slate-200 outline-none">
                    <select id="inputAcc" class="p-3 bg-slate-50 rounded-xl text-sm font-bold text-slate-600 border-none ring-1 ring-slate-200 outline-none">
                        <option value="banco1">Banesco</option><option value="banco2">BNC</option><option value="banco3">Bancaribe</option><option value="caja">Caja</option>
                    </select>
                    <div class="md:col-span-4 flex gap-2">
                        <button type="submit" id="btnSubmit" class="flex-[3] bg-slate-900 text-white font-black py-4 rounded-xl text-[10px] uppercase tracking-widest hover:bg-black transition-all">Guardar Registro (Enter)</button>
                        <button type="button" id="btnCancelEdit" class="hidden flex-1 bg-rose-100 text-rose-600 font-black py-4 rounded-xl text-[10px] uppercase tracking-widest hover:bg-rose-200 transition-all">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="bg-white rounded-[2.5rem] p-6 card-shadow border border-slate-100">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest italic">Historial de Transacciones</h3>
                <div class="flex gap-2 items-center bg-slate-50 p-2 rounded-xl border border-slate-100">
                    <input type="date" id="filterStart" class="bg-transparent text-[10px] font-bold outline-none">
                    <span class="text-slate-300 text-[10px]">al</span>
                    <input type="date" id="filterEnd" class="bg-transparent text-[10px] font-bold outline-none">
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="text-[9px] font-black text-slate-400 uppercase border-b border-slate-50">
                        <tr><th class="px-4 py-3">Fecha</th><th class="px-4 py-3">Cuenta</th><th class="px-4 py-3">Concepto</th><th class="px-4 py-3 text-right">$ USD</th><th class="px-4 py-3 text-right">Acciones</th></tr>
                    </thead>
                    <tbody id="transactionList" class="divide-y divide-slate-50"></tbody>
                </table>
            </div>
            <div class="flex justify-center items-center gap-4 mt-6">
                <button id="prevPage" class="p-2 px-4 bg-slate-100 rounded-lg text-[10px] font-black disabled:opacity-30">ANT</button>
                <span id="pageIndicator" class="text-[10px] font-bold text-slate-400 italic">Página 1</span>
                <button id="nextPage" class="p-2 px-4 bg-slate-100 rounded-lg text-[10px] font-black disabled:opacity-30">SIG</button>
            </div>
        </div>
    </main>

    <script>
        const DB = {
            key: 'finanzas_v8_pro_data', rateKey: 'finanzas_v8_pro_rate',
            save(data) { localStorage.setItem(this.key, JSON.stringify(data)); },
            load() { const d = localStorage.getItem(this.key); return d ? JSON.parse(d) : { ingresos: [], egresos: [], cobrar: [], pagar: [], goals: [] }; },
            sanitize(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        };

        const UI = {
            currentPage: 1, itemsPerPage: 10, currentCat: 'ingresos', editingId: null,
            
            notify(msg, type = "success") {
                const container = document.getElementById('toast-container');
                const t = document.createElement('div');
                t.className = `${type === "success" ? "bg-emerald-500" : "bg-rose-500"} text-white px-6 py-3 rounded-2xl font-bold text-[10px] shadow-xl toast show`;
                t.innerText = msg;
                container.appendChild(t);
                setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 3000);
            },

            renderAll(data, rate) {
                this.renderDashboard(data, rate);
                this.renderTable(data, rate);
            },

            renderDashboard(data, rate) {
                const sumUSD = (arr) => arr.reduce((a, b) => a + b.amount, 0);
                const getBal = (id) => data.ingresos.filter(i => i.acc === id).reduce((a,b) => a + b.amount, 0) - data.egresos.filter(i => i.acc === id).reduce((a,b) => a + b.amount, 0);
                const neto = (getBal('banco1')+getBal('banco2')+getBal('banco3')+getBal('caja')) + sumUSD(data.cobrar) - sumUSD(data.pagar);
                
                document.getElementById('saldoNetoUSD').innerText = "$" + neto.toLocaleString('en-US', {minimumFractionDigits:2});
                document.getElementById('saldoNetoBS').innerText = "Bs " + (neto * rate).toLocaleString('es-VE', {minimumFractionDigits:2});

                const banks = { banco1: 'Banesco', banco2: 'BNC', banco3: 'Bancaribe', caja: 'Caja' };
                const colors = { banco1: '#00a859', banco2: '#002e5f', banco3: '#00afca', caja: '#64748b' };
                const cont = document.getElementById('bankSaldos');
                cont.innerHTML = '';
                Object.keys(banks).forEach(id => {
                    cont.innerHTML += `<div class="flex justify-between items-center p-2 bg-slate-50 rounded-xl border-r-4" style="border-color:${colors[id]}">
                        <span class="text-[8px] font-black uppercase text-slate-400">${banks[id]}</span>
                        <span class="font-black text-[11px]">$${getBal(id).toLocaleString('en-US',{minimumFractionDigits:2})}</span>
                    </div>`;
                });
            },

            renderTable(data, rate) {
                const fStart = document.getElementById('filterStart').value;
                const fEnd = document.getElementById('filterEnd').value;
                let list = [...data[this.currentCat]].sort((a,b) => b.id - a.id);
                if(fStart && fEnd) list = list.filter(i => i.date >= fStart && i.date <= fEnd);

                const totalP = Math.ceil(list.length / this.itemsPerPage) || 1;
                const paginated = list.slice((this.currentPage - 1) * this.itemsPerPage, this.currentPage * this.itemsPerPage);
                
                document.getElementById('transactionList').innerHTML = paginated.map(i => `
                    <tr class="text-[11px] hover:bg-slate-50 transition-colors ${this.editingId === i.id ? 'bg-indigo-50' : ''}">
                        <td class="px-4 py-3 text-slate-400 font-medium">${i.date}</td>
                        <td class="px-4 py-3 uppercase font-black text-[9px] text-slate-300">${i.acc}</td>
                        <td class="px-4 py-3 font-semibold text-slate-700">${i.desc}</td>
                        <td class="px-4 py-3 text-right font-black ${this.currentCat==='egresos'||this.currentCat==='pagar'?'text-rose-500':'text-emerald-600'}">${i.amount.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right space-x-2">
                            <button onclick="app.startEdit('${this.currentCat}', ${i.id})" class="text-indigo-400 hover:text-indigo-700 font-bold" title="Editar">✎</button>
                            <button onclick="app.deleteItem('${this.currentCat}', ${i.id})" class="text-slate-200 hover:text-rose-500 font-bold" title="Eliminar">×</button>
                        </td>
                    </tr>`).join('');
                document.getElementById('pageIndicator').innerText = `Página ${this.currentPage} de ${totalP}`;
            }
        };

        const app = {
            state: DB.load(),
            rate: parseFloat(localStorage.getItem(DB.rateKey)) || 45.0,

            init() {
                document.getElementById('financeForm').onsubmit = (e) => { e.preventDefault(); this.handleForm(); };
                document.getElementById('btnCancelEdit').onclick = () => this.cancelEdit();
                document.getElementById('btnExport').onclick = () => this.exportCSV();
                document.getElementById('importFile').onchange = (e) => this.importCSV(e);
                document.getElementById('exchangeRate').oninput = (e) => {
                    this.rate = parseFloat(e.target.value) || 1;
                    localStorage.setItem(DB.rateKey, this.rate);
                    UI.renderAll(this.state, this.rate);
                };
                document.getElementById('filterStart').onchange = () => UI.renderTable(this.state, this.rate);
                document.getElementById('filterEnd').onchange = () => UI.renderTable(this.state, this.rate);
                document.getElementById('prevPage').onclick = () => { if(UI.currentPage > 1){ UI.currentPage--; UI.renderTable(this.state, this.rate); }};
                document.getElementById('nextPage').onclick = () => { if(UI.currentPage < Math.ceil(this.state[UI.currentCat].length/UI.itemsPerPage)){ UI.currentPage++; UI.renderTable(this.state, this.rate); }};

                document.querySelectorAll('#tabGroup button').forEach(btn => {
                    btn.onclick = (e) => {
                        this.cancelEdit();
                        document.querySelectorAll('#tabGroup button').forEach(b => b.className = "flex-1 py-4 text-[9px] uppercase tracking-[0.2em] text-slate-400");
                        e.target.className = "flex-1 py-4 text-[9px] uppercase tracking-[0.2em] tab-active";
                        UI.currentCat = e.target.dataset.cat; UI.currentPage = 1; UI.renderTable(this.state, this.rate);
                    };
                });
                document.getElementById('inputDate').valueAsDate = new Date();
                UI.renderAll(this.state, this.rate);
            },

            handleForm() {
                const date = document.getElementById('inputDate').value;
                const desc = DB.sanitize(document.getElementById('inputDesc').value);
                const amount = parseFloat(document.getElementById('inputAmount').value);
                const acc = (UI.currentCat === 'ingresos' || UI.currentCat === 'egresos') ? document.getElementById('inputAcc').value : 'none';

                if(amount <= 0) return UI.notify("Monto inválido", "error");

                if (UI.editingId) {
                    // MODO ACTUALIZACIÓN
                    const idx = this.state[UI.currentCat].findIndex(i => i.id === UI.editingId);
                    if (idx !== -1) {
                        this.state[UI.currentCat][idx] = { ...this.state[UI.currentCat][idx], date, desc, amount, acc };
                        UI.notify("Registro actualizado");
                    }
                    this.cancelEdit();
                } else {
                    // MODO NUEVO
                    this.state[UI.currentCat].push({ id: Date.now(), date, desc, amount, acc });
                    UI.notify("Registro guardado");
                }

                DB.save(this.state);
                UI.renderAll(this.state, this.rate);
                document.getElementById('inputDesc').value = '';
                document.getElementById('inputAmount').value = '';
            },

            startEdit(cat, id) {
                const item = this.state[cat].find(i => i.id === id);
                if (!item) return;

                UI.editingId = id;
                document.getElementById('inputDate').value = item.date;
                document.getElementById('inputDesc').value = item.desc;
                document.getElementById('inputAmount').value = item.amount;
                document.getElementById('inputAcc').value = item.acc;

                // UI Changes
                document.getElementById('formContainer').classList.add('editing-mode');
                document.getElementById('btnSubmit').innerText = "ACTUALIZAR REGISTRO";
                document.getElementById('btnSubmit').classList.replace('bg-slate-900', 'bg-indigo-600');
                document.getElementById('btnCancelEdit').classList.remove('hidden');
                document.getElementById('editBadge').classList.remove('hidden');
                UI.renderTable(this.state, this.rate);
                window.scrollTo({ top: document.getElementById('formContainer').offsetTop - 100, behavior: 'smooth' });
            },

            cancelEdit() {
                UI.editingId = null;
                document.getElementById('formContainer').classList.remove('editing-mode');
                document.getElementById('btnSubmit').innerText = "GUARDAR REGISTRO (ENTER)";
                document.getElementById('btnSubmit').classList.replace('bg-indigo-600', 'bg-slate-900');
                document.getElementById('btnCancelEdit').classList.add('hidden');
                document.getElementById('editBadge').classList.add('hidden');
                document.getElementById('financeForm').reset();
                document.getElementById('inputDate').valueAsDate = new Date();
                UI.renderTable(this.state, this.rate);
            },

            quickAdjust() {
                const acc = document.getElementById('adjAcc').value;
                const target = parseFloat(document.getElementById('adjVal').value);
                if(isNaN(target)) return UI.notify("Monto requerido", "error");
                
                const getBal = (id) => this.state.ingresos.filter(i => i.acc === id).reduce((a,b) => a + b.amount, 0) - this.state.egresos.filter(i => i.acc === id).reduce((a,b) => a + b.amount, 0);
                const diff = target - getBal(acc);
                if(diff === 0) return UI.notify("El saldo ya es correcto");

                this.state[diff > 0 ? 'ingresos' : 'egresos'].push({
                    id: Date.now(), date: new Date().toISOString().split('T')[0],
                    desc: "Ajuste manual de saldo", amount: Math.abs(diff), acc: acc
                });
                DB.save(this.state); UI.renderAll(this.state, this.rate);
                UI.notify("Saldo conciliado");
                document.getElementById('adjVal').value = '';
            },

            deleteItem(cat, id) {
                if(confirm("¿Eliminar este registro?")) {
                    this.state[cat] = this.state[cat].filter(i => i.id !== id);
                    DB.save(this.state); UI.renderAll(this.state, this.rate);
                    UI.notify("Eliminado", "error");
                }
            },

            exportCSV() {
                let rows = [['Tipo', 'Fecha', 'Cuenta', 'Concepto', 'USD']];
                Object.keys(this.state).forEach(cat => {
                    if(Array.isArray(this.state[cat]) && cat !== 'goals') this.state[cat].forEach(i => rows.push([cat, i.date, i.acc, i.desc, i.amount]));
                });
                let csv = "data:text/csv;charset=utf-8,\ufeff" + rows.map(e => e.join(",")).join("\n");
                let link = document.createElement("a");
                link.setAttribute("href", encodeURI(csv)); link.setAttribute("download", `Backup_V84.csv`); link.click();
            },

            importCSV(e) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const lines = ev.target.result.split('\n');
                    const temp = { ingresos: [], egresos: [], cobrar: [], pagar: [], goals: [] };
                    lines.forEach((l, idx) => {
                        if(idx === 0 || !l.trim()) return;
                        const p = l.split(',');
                        if(p.length >= 5){
                            const cat = p[0].trim().toLowerCase();
                            if(temp[cat]) temp[cat].push({ id: Date.now()+Math.random(), date: p[1].trim(), acc: p[2].trim(), desc: DB.sanitize(p[3].trim()), amount: parseFloat(p[4].trim()) });
                        }
                    });
                    this.state = temp; DB.save(this.state); UI.renderAll(this.state, this.rate); UI.notify("Importado con éxito");
                };
                reader.readAsText(e.target.files[0]);
            }
        };

        app.init();
    </script>
</body>
</html>