<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Master V11.3 - BCV Auto-Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; color: #0f172a; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .tab-active { border-bottom: 4px solid #6366f1; color: #6366f1; font-weight: 800; }
        .modal { transition: opacity 0.2s; opacity: 0; visibility: hidden; pointer-events: none; position: fixed; inset: 0; z-index: 1000; }
        .modal.active { opacity: 1; visibility: visible; pointer-events: auto; }
        .editing-glow { border: 3px solid #6366f1 !important; box-shadow: 0 0 20px rgba(99, 102, 241, 0.2); }
        .sync-pulse { animation: sync-pulse 1.5s infinite; }
        @keyframes sync-pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="pb-20">

    <div id="toast-container"></div>

    <header class="bg-slate-900 text-white p-5 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-6xl mx-auto space-y-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 border-b border-slate-800 pb-4">
                <div class="flex flex-col">
                    <h1 class="text-xl font-black italic uppercase tracking-tighter">Finanzas <span class="text-indigo-400">V11.3</span></h1>
                    <div id="cloudStatus" class="flex items-center gap-2 mt-1">
                        <div id="statusDot" class="w-2 h-2 bg-rose-500 rounded-full"></div>
                        <span id="statusText" class="text-[7px] font-black uppercase text-slate-500 tracking-widest">Nube Desconectada</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 bg-slate-800 p-2 px-6 rounded-2xl border border-slate-700">
                    <div class="text-right">
                        <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest mb-1">Tasa Oficial BCV (Bs)</p>
                        <input type="number" id="exchangeRate" value="45.00" step="0.01" class="bg-transparent text-xl font-black text-white w-24 outline-none border-b-2 border-indigo-500 text-center focus:border-emerald-400 transition-all">
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap justify-center md:justify-end gap-2">
                <button id="btnSyncDrive" class="bg-white text-slate-900 px-4 py-2 rounded-xl font-black text-[9px] uppercase flex items-center gap-2 shadow-lg hover:scale-105 transition-all">
                    <svg class="w-3 h-3" viewBox="0 0 24 24"><path fill="#4285F4" d="M21.3 14.5l-6.3-11c-.3-.5-.9-.8-1.5-.8H6.5c-.6 0-1.2.3-1.5.8L.7 14.5c-.3.5-.3 1.1 0 1.6l3.2 5.5c.3.5.9.8 1.5.8h13.1c.6 0 1.2-.3 1.5-.8l3.2-5.5c.4-.5.4-1.1.1-1.6zm-14.8 5.4l-1.6-2.8 4.7-8.1 1.6 2.8-4.7 8.1zm10.7 0H7.7l4.7-8.1 9.5 0-4.7 8.1zm-1.6-11l-4.7-8.1 3.2 0 4.7 8.1-3.2 0z"/></svg>
                    Conectar Google Drive
                </button>
                <button id="btnToggleCharts" class="bg-slate-700 px-3 py-2 rounded-xl font-bold text-[9px] uppercase">Gráficos</button>
                <button id="btnPDF" class="bg-sky-600 px-3 py-2 rounded-xl font-bold text-[9px] uppercase">PDF</button>
                <button onclick="app.toggleModal(true)" class="bg-indigo-600 px-3 py-2 rounded-xl font-bold text-[9px] uppercase">Bancos</button>
                <button id="btnReset" class="bg-rose-600 px-3 py-2 rounded-xl font-bold text-[9px] uppercase">Reset</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">
        <div id="reportContainer" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-[2.5rem] card-shadow h-[300px]"><canvas id="chartAccounts"></canvas></div>
            <div class="bg-white p-6 rounded-[2.5rem] card-shadow h-[300px]"><canvas id="chartFlow"></canvas></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 bg-slate-900 rounded-[3rem] p-10 text-white shadow-2xl flex flex-col justify-center">
                <p class="text-indigo-400 text-[10px] font-black uppercase tracking-[0.4em] mb-2">Patrimonio Neto Total</p>
                <h2 id="saldoNetoUSD" class="text-6xl font-black tracking-tighter">$ 0.00</h2>
                <h3 id="saldoNetoBS" class="text-2xl font-bold text-slate-500 mt-2">Bs 0,00</h3>
            </div>

            <div class="bg-white rounded-[2.5rem] p-8 card-shadow border border-slate-100 flex flex-col">
                <h3 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest italic">Saldos de Cuentas</h3>
                <div class="flex-1 overflow-y-auto custom-scrollbar mb-4 max-h-40">
                    <table class="w-full"><tbody id="bankSaldos" class="divide-y divide-slate-50 text-xs font-bold"></tbody></table>
                </div>
                <div class="pt-4 border-t border-slate-100 space-y-2">
                    <select id="adjAcc" class="w-full p-3 bg-slate-50 rounded-xl text-xs font-bold border-none ring-1 ring-slate-100 outline-none"></select>
                    <div class="flex gap-2">
                        <input type="number" id="adjValUSD" placeholder="$ Real" class="w-1/2 p-3 bg-slate-50 rounded-xl text-xs font-bold ring-1 ring-slate-100 outline-none">
                        <input type="number" id="adjValBS" placeholder="Bs Real" class="w-1/2 p-3 bg-slate-50 rounded-xl text-xs font-bold ring-1 ring-slate-100 outline-none">
                    </div>
                    <button id="btnQuickAdjust" class="w-full bg-slate-900 text-white text-[10px] font-black py-4 rounded-xl uppercase hover:bg-black transition-all">Conciliar Saldo</button>
                </div>
            </div>
        </div>

        <div id="formContainer" class="bg-white rounded-[3rem] card-shadow overflow-hidden border-4 border-transparent transition-all">
            <div class="flex flex-wrap bg-slate-50/50 border-b" id="tabGroup">
                <button data-cat="ingresos" class="flex-1 py-5 text-[10px] font-black uppercase tracking-widest tab-active">Entrada</button>
                <button data-cat="egresos" class="flex-1 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400">Salida</button>
                <button data-cat="cobrar" class="flex-1 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400">Por Cobrar</button>
                <button data-cat="pagar" class="flex-1 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400">Por Pagar</button>
            </div>
            <div class="p-8 relative">
                <div id="editBadge" class="hidden absolute -top-4 right-10 bg-indigo-600 text-white px-6 py-2 rounded-full text-[10px] font-black uppercase animate-bounce shadow-lg">✏️ Modo Edición</div>
                <form id="financeForm" class="grid grid-cols-1 md:grid-cols-5 gap-6">
                    <div class="flex flex-col gap-1"><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Fecha</label><input type="date" id="inputDate" required class="p-4 bg-slate-50 rounded-2xl text-sm font-bold border-none ring-1 ring-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div class="flex flex-col gap-1"><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Descripción</label><input type="text" id="inputDesc" placeholder="..." required class="p-4 bg-slate-50 rounded-2xl text-sm font-bold border-none ring-1 ring-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div class="flex flex-col gap-1 md:col-span-2"><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Monto ($ ⇄ Bs)</label><div class="flex gap-2 p-1 bg-slate-50 rounded-2xl ring-1 ring-slate-200"><input type="number" id="inputAmount" step="0.01" placeholder="$" required class="w-1/2 p-3 bg-transparent text-lg font-black text-indigo-600 outline-none"><input type="number" id="inputAmountBS" step="0.01" placeholder="Bs" class="w-1/2 p-3 bg-transparent text-lg font-black text-slate-600 outline-none"></div></div>
                    <div class="flex flex-col gap-1"><label class="text-[9px] font-black text-slate-400 uppercase ml-2">Cuenta</label><select id="inputAcc" class="p-4 bg-slate-50 rounded-2xl text-sm font-bold border-none ring-1 ring-slate-200 outline-none focus:ring-2 focus:ring-indigo-500"></select></div>
                    <div class="md:col-span-5 flex gap-4"><button type="submit" id="btnSubmit" class="flex-1 bg-slate-900 text-white font-black py-5 rounded-2xl text-xs uppercase shadow-xl hover:bg-black transition-all">Guardar Datos</button><button type="button" id="btnCancelEdit" class="hidden w-40 bg-rose-500 text-white font-black rounded-2xl text-[10px] uppercase">Cancelar</button></div>
                </form>
            </div>
        </div>

        <div class="bg-white rounded-[3rem] p-8 card-shadow border border-slate-100">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4"><h3 class="text-xs font-black text-slate-400 uppercase tracking-widest italic">Historial Corregible</h3><div class="flex items-center gap-3"><button id="btnPrev" class="px-4 py-2 bg-slate-100 rounded-xl hover:bg-indigo-600 hover:text-white transition-all disabled:opacity-30">⬅</button><span id="pageIndicator" class="text-[10px] font-black text-slate-600 uppercase">Pág 1</span><button id="btnNext" class="px-4 py-2 bg-slate-100 rounded-xl hover:bg-indigo-600 hover:text-white transition-all disabled:opacity-30">➡</button></div></div>
            <div class="overflow-x-auto"><table class="w-full text-left border-separate border-spacing-y-2"><thead><tr class="text-[10px] font-black text-slate-400 uppercase tracking-wider"><th class="px-6 py-2">Fecha</th><th class="px-6 py-2">Cuenta</th><th class="px-6 py-2">Concepto</th><th class="px-6 py-2 text-right">USD</th><th class="px-6 py-2 text-right">BS</th><th class="px-6 py-2 text-center">Acción</th></tr></thead><tbody id="transactionList"></tbody></table></div>
        </div>
    </main>

    <div id="bankModal" class="modal flex items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="app.toggleModal(false)"></div>
        <div class="bg-white w-11/12 max-w-md rounded-[2.5rem] shadow-2xl z-[1001] overflow-hidden relative p-8">
            <h3 class="text-xl font-black text-slate-800 uppercase mb-6 italic">Mis Cuentas</h3>
            <div class="space-y-4">
                <div class="flex gap-2"><input type="text" id="newBankName" placeholder="Zelle, Banesco..." class="flex-1 p-3 bg-slate-50 rounded-xl border-none ring-1 ring-slate-200 font-bold outline-none"><button id="btnAddBank" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-black text-[10px] uppercase">Añadir</button></div>
                <div id="bankListManaged" class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>
        </div>
    </div>

    <div id="pdfReport" class="hidden p-10 bg-white"><h1 class="text-2xl font-black uppercase mb-2">Cierre Financiero</h1><hr class="mb-5 border-2 border-slate-900"><div id="pdfBody"></div></div>

    <script>
        /* CREDENCIALES INTEGRADAS */
        const CLIENT_ID = '333415357306-m0gdg683did4ci4l1i74hga0vgcnblbp.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBy6D75us4mmH9hM14rCbg_56Vz0YVtc00';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        function gapiLoaded() { gapi.load('client', async () => { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); gapiInited = true; }); }
        function gisLoaded() { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '', }); gisInited = true; }

        const DB = {
            key: 'finanzas_v11_2_data',
            rateKey: 'finanzas_v11_2_rate',
            save(data) { 
                localStorage.setItem(this.key, JSON.stringify(data));
                if(gapi.client?.getToken()) app.syncToDrive();
            },
            load() { 
                const d = localStorage.getItem(this.key); 
                let state = d ? JSON.parse(d) : { ingresos: [], egresos: [], cobrar: [], pagar: [], banks: ["Caja Chica / Efectivo"] }; 
                if(!state.banks.includes("Caja Chica / Efectivo")) state.banks.unshift("Caja Chica / Efectivo");
                return state;
            }
        };

        const app = {
            state: DB.load(),
            rate: parseFloat(localStorage.getItem(DB.rateKey)) || 45.0,
            driveFileId: null, currentPage: 1, itemsPerPage: 10, currentCat: 'ingresos', editingId: null, chartsVisible: false,
            chart1: null, chart2: null,

            /* --- AUTOMATIZACIÓN BCV --- */
            async fetchBCV() {
                try {
                    const response = await fetch('https://ve.dolarapi.com/v1/dolares/oficial');
                    const data = await response.json();
                    if (data && data.promedio) {
                        const tasaOficial = parseFloat(data.promedio).toFixed(2);
                        if (this.rate !== parseFloat(tasaOficial)) {
                            this.rate = parseFloat(tasaOficial);
                            document.getElementById('exchangeRate').value = this.rate;
                            localStorage.setItem(DB.rateKey, this.rate);
                            this.render();
                            DB.save(this.state);
                            this.notify(`Tasa BCV: ${this.rate} Bs`, "success");
                        }
                    }
                } catch (error) {
                    console.error("Error BCV:", error);
                    this.notify("Error conectando al BCV", "error");
                }
            },

            init() {
                document.getElementById('exchangeRate').value = this.rate;
                document.getElementById('inputDate').valueAsDate = new Date();
                
                // Cargar Tasa Automática al iniciar
                this.fetchBCV();

                document.getElementById('btnSyncDrive').onclick = () => this.handleAuth();
                document.getElementById('exchangeRate').oninput = (e) => { this.rate = parseFloat(e.target.value) || 1; localStorage.setItem(DB.rateKey, this.rate); this.render(); DB.save(this.state); };
                document.getElementById('financeForm').onsubmit = (e) => { e.preventDefault(); this.handleForm(); };
                document.getElementById('btnAddBank').onclick = () => this.addBank();
                document.getElementById('btnPrev').onclick = () => { if(this.currentPage > 1) { this.currentPage--; this.render(); }};
                document.getElementById('btnNext').onclick = () => { this.currentPage++; this.render(); };
                document.getElementById('btnQuickAdjust').onclick = () => this.quickAdjust();
                document.getElementById('btnCancelEdit').onclick = () => this.cancelEdit();
                document.getElementById('btnToggleCharts').onclick = () => this.toggleCharts();
                document.getElementById('btnPDF').onclick = () => this.generatePDF();
                document.getElementById('btnReset').onclick = () => this.resetData();

                this.bindSync('inputAmount', 'inputAmountBS', 'usd');
                this.bindSync('inputAmountBS', 'inputAmount', 'bs');
                this.bindSync('adjValUSD', 'adjValBS', 'usd');
                this.bindSync('adjValBS', 'adjValUSD', 'bs');

                document.querySelectorAll('#tabGroup button').forEach(btn => {
                    btn.onclick = (e) => {
                        this.cancelEdit();
                        document.querySelectorAll('#tabGroup button').forEach(b => b.className = "flex-1 py-5 text-[10px] font-black uppercase tracking-widest text-slate-400");
                        e.target.className = "flex-1 py-5 text-[10px] font-black uppercase tracking-widest tab-active";
                        this.currentCat = e.target.dataset.cat;
                        this.currentPage = 1; this.render();
                    };
                });
                this.render();
            },

            async handleAuth() {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) throw (resp);
                    this.updateStatus(true);
                    await this.loadFromDrive();
                };
                tokenClient.requestAccessToken({prompt: gapi.client.getToken() === null ? 'consent' : ''});
            },

            async syncToDrive() {
                try {
                    document.getElementById('statusDot').classList.add('sync-pulse');
                    const content = JSON.stringify(this.state);
                    if (this.driveFileId) {
                        await gapi.client.request({ path: '/upload/drive/v3/files/' + this.driveFileId, method: 'PATCH', params: { uploadType: 'media' }, body: content });
                    } else {
                        const metadata = { name: 'finanzas_master_cloud.json', mimeType: 'application/json' };
                        const form = new FormData();
                        form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                        form.append('file', new Blob([content], {type: 'application/json'}));
                        const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                            method: 'POST', headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }), body: form
                        });
                        const res = await resp.json(); this.driveFileId = res.id;
                    }
                    setTimeout(() => document.getElementById('statusDot').classList.remove('sync-pulse'), 1000);
                } catch (e) { console.error(e); }
            },

            async loadFromDrive() {
                const resp = await gapi.client.drive.files.list({ q: "name = 'finanzas_master_cloud.json' and trashed = false" });
                const files = resp.result.files;
                if (files.length > 0) {
                    this.driveFileId = files[0].id;
                    const file = await gapi.client.drive.files.get({ fileId: this.driveFileId, alt: 'media' });
                    this.state = typeof file.result === 'string' ? JSON.parse(file.result)